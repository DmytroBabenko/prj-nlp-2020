# streamlit run --server.runOnSave true app.py
#
import streamlit as st
import base64

from spacy import displacy

st.markdown(
"""
<style>
header .decoration {
  background-image: linear-gradient(90deg,#1eb4e9,#1eb4e9);
}
.reportview-container .main .block-container {
  padding: 0;
}
code {
  color: #e91e3a;
}
.st-c5 {
  border-color: #1eb4e9;
}
</style>
""", unsafe_allow_html=True)
#st.image('https://i.imgur.com/CJxBSYA.jpg', use_column_width=True)

st.title("ü§¶üèº‚Äç‚ôÄÔ∏è Feminizer")
st.write('–§–µ–º—ñ–Ω–∞–π–∑–µ—Ä –≤–∏—è–≤–ª—è—î –ø—Ä–æ“ë–∞–≤–ª–µ–Ω—ñ —Ñ–µ–º—ñ–Ω—ñ—Ç–∏–≤–∏.')
st.write('')

samples = """\
–ï–∫–∞ –ó–≥—É–ª–∞–¥–∑–µ –π–¥–µ –∑ –ø–æ—Å–∞–¥–∏ –ø–µ—Ä—à–æ–≥–æ –∑–∞—Å—Ç—É–ø–Ω–∏–∫–∞ –º—ñ–Ω—ñ—Å—Ç—Ä–∞ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ—Ö —Å–ø—Ä–∞–≤
–Ø –ø–æ—á–∞–ª–∞ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º—ñ—Å—Ç–æ–º –Ω–∞ –¥—Ä—É–≥–æ–º—É –∫—É—Ä—Å—ñ –Ω–∞–≤—á–∞–Ω–Ω—è
–ê–≤—Ç–æ—Ä–æ–º —Ä–æ–±–æ—Ç–∏ —î —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ –û–ª—å–≥–∞ –ë–∞—Ä–∞–Ω–µ—Ü—å
–í–æ–ª–æ–¥—è –Ω–µ –±—É–≤ –ø–∏—è–∫–æ–º —Ä–æ–∑–ø–æ–≤—ñ–ª–∞ –∫–æ—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç–æ–≤—ñ –í–∏—Å–æ–∫–æ–≥–æ –ó–∞–º–∫—É –≥–æ–ª–æ–≤–∞ –ú–µ—á–∏—â—ñ–≤—Å—å–∫–æ—ó —Å—ñ–ª—å—Ä–∞–¥–∏ –Ñ–≤–≥–µ–Ω—ñ—è –°–∫—Ä–∏–ø–µ—Ü—å–∫–∞
–í–∞–∂–∫–æ –ø–æ—Ä–∞–Ω–µ–Ω—ñ 22-—Ä—ñ—á–Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤—ñ–¥–µ–æ—Å–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è –π –æ–¥–∏–Ω –∑–∞—Å—É–¥–∂–µ–Ω–∏–π
–Æ–Ω–∞ –¥–∏–∑–∞–π–Ω–µ—Ä –∫–∞–∂–µ —â–æ –Ω–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–¥—è–≥—É —ó—ó –Ω–∞–¥–∏—Ö–Ω—É–ª–∏ –µ–ª–µ–∫—Ç—Ä–∏–∫–∞ –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–µ –º–∏—Å—Ç–µ—Ü—Ç–≤–æ —Ç–∞ —Ñ—ñ–ª—å–º–∏ –û–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ –®–∞–ø—ñ—Ä–æ
–í–æ–Ω–∞ —É –Ω–∞—Å —è–∫ —Ç–æ–π –¥—Ä–∞–∫–æ–Ω, —â–æ –¥–∏—Ö–∞—î –≤–æ–≥–Ω–µ–º —ñ –≤—ñ–¥–ª—è–∫—É—î –≤–æ—Ä–æ–≥—ñ–≤
–¶—å–æ–≥–æ —Ä–æ–∫—É –≤ –Ω—ñ–π –±—Ä–∞–ª–∏ —É—á–∞—Å—Ç—å –¥–µ—Ä–∂—Å–µ–∫—Ä–µ—Ç–∞—Ä –ù–∞—Ç–∞–ª—è, –¥—Ä—É–∂–∏–Ω–∞ –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞ –°–®–ê –ú—ñ—à–µ–ª—å –û–±–∞–º–∞, –ª–∞—É—Ä–µ–∞—Ç–∏ –ù–æ–±–µ–ª—ñ–≤—Å—å–∫–æ—ó –ø—Ä–µ–º—ñ—ó –º–∏—Ä—É 2011 –õ–µ–π–º–∞ –ì–±–æ—É —ñ –¢–∞–≤–∞–∫—É–ª—å –ö–∞—Ä–º–∞–Ω
–ü–µ—Ä—à–∏–º —Ç—Ä–µ–Ω–µ—Ä–æ–º –±—É–ª–∞ –†–∞—ó—Å–∞ –ë–µ–∑—Å–æ–Ω–æ–≤–∞
–ù–∞–≥–∞–¥–∞—î–º–æ, —Ä–∞–Ω—ñ—à–µ –ø–æ–≤—ñ–¥–æ–º–ª—è–ª–æ—Å—è, —â–æ –£–∫—Ä–∞—ó–Ω–∞ –Ω–∞–ø—Ä–∞–≤–∏–ª–∞ –∫—Ä–∞—ó–Ω–∞–º –ú–∏—Ç–Ω–æ–≥–æ —Å–æ—é–∑—É –ø—Ä–æ–µ–∫—Ç –º–µ–º–æ—Ä–∞–Ω–¥—É–º—É –ø—Ä–æ –Ω–∞–¥–∞–Ω–Ω—è —ó–π —Å—Ç–∞—Ç—É—Å—É —Å–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞—á–∞
–Ø –ø—Ä–æ—Ö–æ–¥–∏–ª–∞ –∫–æ–º—ñ—Å—ñ—é —â–æ—Ä–æ–∫—É, —è –∂ –≤—ñ–π—Å—å–∫–æ–≤–∏–π –ª—å–æ—Ç—á–∏–∫
–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç –∑—ñ–±—Ä–∞–ª–∞ –µ–∫—Å—Ç—Ä–µ–Ω—É –Ω–∞—Ä–∞–¥—É —Å–∏–ª–æ–≤–∏–∫—ñ–≤
–ü–æ—Å–æ–ª –í–µ–ª–∏–∫–æ—ó –ë—Ä–∏—Ç–∞–Ω—ñ—ó –≤ –£–∫—Ä–∞—ó–Ω—ñ –ø–∞–Ω—ñ –î–∂—É–¥—ñ—Ç –ì–æ—Ñ —Ä–æ–∑–ø–æ—á–∞–ª–∞ –Ω–∞—Ä–∞–¥—É
–û—Ç–∞, —â–æ –ø—Ä–∏–±—ñ–≥–∞–ª–∞ –¥–æ —Ç–µ–±–µ, –≤–æ–Ω–∞ —Ç–µ–∂ —Å—Ç—É–¥–µ–Ω—Ç?
–ü—Ä–æ —Ü–µ –¢–µ–ª–µ–∫—Ä–∏—Ç–∏—Ü—ñ –ø–æ–≤—ñ–¥–æ–º–∏–ª–∞ –∂—É—Ä–Ω–∞–ª—ñ—Å—Ç –∫–∞–Ω–∞–ª—É –ê–Ω–∞—Å—Ç–∞—Å—ñ—è –°—Ç–∞–Ω–∫–æ
–í–∏–±–æ—Ä–∏ –º–µ—Ä–∞ –ö–∏—î–≤–∞ –≤—ñ–¥–±—É–¥—É—Ç—å—Å—è —Ç–≤–µ—Ä–¥–æ —Ü—å–æ–≥–æ —Ä–æ–∫—É —Å–∫–∞–∑–∞–ª–∞ –ª—ñ–¥–µ—Ä –ë–Æ–¢
–ì–ü–£ –≤–∏–∫–ª–∏–∫–∞–ª–∞ –Ω–∞ –¥–æ–ø–∏—Ç –Ω–∞—Ä–æ–¥–Ω–∏—Ö –¥–µ–ø—É—Ç–∞—Ç—ñ–≤ –≤—ñ–¥ –û–ø–æ–∑–∏—Ü—ñ–π–Ω–æ–≥–æ –ë–ª–æ–∫—É –ù–∞—Ç–∞–ª—é –ö–æ—Ä–æ–ª–µ–≤—Å—å–∫—É, –û–ª–µ–∫—Å–∞–Ω–¥—Ä–∞ –í—ñ–ª–∫—É–ª–∞, –∞ –í–∞–¥–∏–º–∞ –ù–æ–≤–∏–Ω—Å—å–∫–æ–≥–æ –¥–æ –ú–í–°
–ó–∞ —Å–ª–æ–≤–∞–º–∏ –ù–∞—Ç–∞–ª—ñ—ó –°–µ—Ä–±–∏–Ω –∑ –≥—Ä–æ–º–∞–¥—Å—å–∫–æ—ó –ù–∞—Ä–æ–¥–Ω–æ—ó —Ä–∞–¥–∏ —Å—Ç—Ä–∞–π–∫ –æ–≥–æ–ª–æ—Å–∏–ª–∏ –±–æ —Å—Ç—É–¥–µ–Ω—Ç–∏ –º–∞—é—Ç—å –ø–µ–≤–Ω—ñ –ø—Ä–∞–≤–∞ —è–∫—ñ –Ω–µ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è
–ü—Ä–æ —Ü–µ –∑–∞—è–≤–∏–ª–∞ –∫–µ—Ä—ñ–≤–Ω–∏–∫ —Ñ—Ä–∞–∫—Ü—ñ—ó –ë–ª–æ–∫—É –í—ñ—Ç—Ä–µ–Ω–∫–æ –≤ –î–æ–Ω–µ—Ü—å–∫–æ—ó –æ–±–ª–∞—Å–Ω—ñ–π —Ä–∞–¥—ñ –ù–∞—Ç–∞–ª—ñ—è –ë—ñ–ª–æ—Ü–µ—Ä–∫—ñ–≤—Å—å–∫–∞
–ë—É–≤ –ø—Ä–æ—Ñ–µ—Å–æ—Ä–æ–º –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ–≥–æ –ø–∏—Å—å–º–µ–Ω–Ω–∏—Ü—Ç–≤–∞ –≤ –£–Ω—ñ–≤–µ—Ä—Å–∏—Ç–µ—Ç—ñ –ê–¥–µ–ª–∞—ó–¥–∏
–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞ –≤—ñ–¥–¥—ñ–ª—É –º–µ—Ç–µ–æ—Ä–æ–ª–æ–≥—ñ—á–Ω–∏—Ö –ø—Ä–æ–≥–Ω–æ–∑—ñ–≤ –õ—é–¥–º–∏–ª–∏ –°–∞–≤—á–µ–Ω–∫–æ —î –Ω–µ–ø—Ä–∞–≤–¥–∏–≤–∏–º–∏
–ü—ñ–¥ –ª–∏—Å—Ç–æ–º, —É —è–∫–æ–º—É –≤–∏–º–∞–≥–∞—î—Ç—å—Å—è –∑–≤—ñ–ª—å–Ω–∏—Ç–∏ 30 –∑–∞–∞—Ä–µ—à—Ç–æ–≤–∞–Ω–∏—Ö —É –ú—É—Ä–º–∞–Ω—Å—å–∫—É –∞–∫—Ç–∏–≤—ñ—Å—Ç—ñ–≤ Greenpeace, –ø—ñ–¥–ø–∏—Å–∞–ª–∏—Å—è –±—ñ–ª—å—à–µ 16 —Ç–∏—Å—è—á –æ—Å—ñ–±
–Ü–Ω—ñ—Ü—ñ–∞—Ç–æ—Ä–æ–º –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è —Ç—É—Ä–Ω—ñ—Ä—É –ø—ñ–¥ –≤—ñ–¥–∫—Ä–∏—Ç–∏–º –Ω–µ–±–æ–º –≤–∏—Å—Ç—É–ø–∏–ª–∞ –ø—Ä–æ–º–æ—É—Ç–µ—Ä—Å—å–∫–∞ –∫–æ–º–ø–∞–Ω—ñ—è Elite-Boxing
–ü–∞—Ä—Ç—ñ—è –≤–∏—Å—É–Ω—É–ª–∞ –Æ–ª—ñ—é –¢–∏–º–æ—à–µ–Ω–∫–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–º –Ω–∞ –ø—Ä–∏—Å—É–¥–∂–µ–Ω–Ω—è –ù–æ–±–µ–ª—ñ–≤—Å—å–∫–æ—ó –ø—Ä–µ–º—ñ—ó –º–∏—Ä—É
–ó–≥–æ–¥–æ–º —Å—Ç–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω–∏–º —á–ª–µ–Ω–æ–º –°–ø—ñ–ª–∫–∏ —Ç–µ–∞—Ç—Ä–∞–ª—å–Ω–∏—Ö –¥—ñ—è—á—ñ–≤
""".splitlines()

#with open('directfem.txt.3') as f:
#    samples = [line.strip().split(':')[1] for line in f]

@st.cache(allow_output_mutation=True)
def load_nlp():
    import stanza
    from spacy_stanza import StanzaLanguage
    nlp = stanza.Pipeline(lang='uk')
    snlp = StanzaLanguage(nlp)
    return nlp, snlp

def write_svg(svg):
    b64 = base64.b64encode(svg.encode('utf-8')).decode("utf-8")
    css = '<p style="text-align:center; display: flex; justify-content: left;">'
    html = r'<img style="padding-bottom:10px;" src="data:image/svg+xml;base64,%s"/>' % b64
    st.write(css+html, unsafe_allow_html=True)

def write_svg1(svg):
    html = f'<figure>{svg}</figure>'
    st.write(html, unsafe_allow_html=True)

def cy(x):
    return displacy.render(x, options=dict(compact=True, collapse_phrases=True, word_spacing=15, distance=100))

@st.cache(allow_output_mutation=True)
def snlp(sentence):
    nlp, snlp = load_nlp()
    return snlp(sentence)

@st.cache(allow_output_mutation=True)
def nlp(sentence):
    nlp, snlp = load_nlp()
    return nlp(sentence)

import fem

@st.cache(allow_output_mutation=True)
def ignore():
    return {}
    #return {2, 3, 4, 5, 6, 7, 12, 13, 14, 15, 16, 17, 18, 22, 23, 24, 25, 26, 27, 29, 32}

#st.write(ignore())

for i, s in enumerate(samples):
    if s[0] == '#':
        continue

    if i in ignore():
        continue

    #st.subheader(s)
    t = s
    s = st.text_input(s, s, key=f'edit{i}')
    if not s:
        continue
    if s != t:
        print('new:', s)
    #print(len(s), s)

    sent = nlp(s).sentences[0]

    ch = fem.children(sent)
    for p,r,o in fem.verify(sent):
        st.write((fem.fmt(p), r, fem.fmt(o)))
        if r == 'nsubj' and fem.case(o) == 'Acc':
            st.warning('Acc!')

    #if st.checkbox('ignore', value=i in ignore(), key=f'ignore{i}'):
    #    ignore().add(i)

    if st.checkbox('ü§î', key=f'more{i}'):
        write_svg(cy(snlp(s)))
        st.write(['root'] + [fem.fmt(w, feats=True) for w in sent.words])

        st.write([(fem.fmt(f), r, fem.fmt(t)) for f,r,t in sent.dependencies])
